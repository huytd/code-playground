<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <script src="lib/codemirror.min.js"></script>
  <link rel="stylesheet" href="lib/codemirror.css"/>
  <link rel="stylesheet" href="lib/material-darker.css">
  <script src="lib/clike.js"></script>
  <script src="lib/sublime.js"></script>
  <style>
    html {
      box-sizing: border-box;
    }

    *, ::before, ::after {
      box-sizing: inherit;
    }

    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #282828;
      color: #ccc;
      display: flex;
      flex-direction: column;
      font-family: Monaco, 'Lucida Console', monospace;
      font-size: 12.5px;
    }

    .CodeMirror {
      width: 100%; height: 100%;
      font-family: Monaco, 'Lucida Console', monospace;
      font-size: 12.5px;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: row;
    }

    #editor {
      flex: 1;
    }

    #output {
      width: 35%;
      font-family: Monaco, 'Lucida Console', monospace;
      font-size: 12.5px;
      margin: 0; padding: 10px;
      display: flex;
      flex-direction: column;
    }

    #output textarea {
      outline: none;
      resize: none;
      background-color: #222;
      color: #FFF;
      border: none;
      padding: 10px;
      height: 100px;
      width: 100%;
      margin: 5px 0;
    }

    #stdout {
      flex: 1;
      height: 100%;
      width: 100%;
      padding: 10px;
      overflow-x: auto;
      overflow-y: auto;
    }

    #stderr {
      padding: 10px;
      height: 100%;
      width: 100%;
      color: #f07178;
      overflow-x: auto;
      overflow-y: auto;
    }

    details summary {
      color: #888;
    }

    .header {
      padding: 10px 15px;
    }

    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: #333;
      border: 1px solid #555;
      color: #dddddd;
      padding: 3px 30px 3px 5px;
      position: relative;
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAAcUlEQVRIie2Puw2AMBQDHRZjnJSMAqlgWo6CIEFEIj5BNO9qy2dLhmH8B+CA9kKuBdyT8gDMQFfI+ZiZcpKm5JHkJPVnEsBLGmPmPvHFwMrhyW45pfWPJNXKE0nYSbby8Lo886TO8oKkfnki+abcMLIsXdC+QY2m3bcAAAAASUVORK5CYII=");
      background-repeat: no-repeat;
      background-position: center right;
    }
  </style>
</head>

<body>
  <div class="header">
    language: <select id="language-select">
      <option value="cpp">C++</option>
      <option value="python">Python</option>
      <option value="rust">Rust</option>
    </select>
  </div>
  <div class="container">
    <div id="editor"></div>
    <div id="output">
      <details id="stdindetails">
        <summary>Standard Input</summary>
        <textarea id="stdin"></textarea>
      </details>
      <details open="true">
        <summary>Standard Output</summary>
        <pre id="stdout"></pre>
      </details>
      <details open="true">
        <summary>Standard Error</summary>
        <pre id="stderr"></pre>
      </details>
    </div>
  </div>
  <script>
    let language = window.localStorage.getItem('__cpppad-saved-language') || 'cpp';

    const cm = CodeMirror(document.querySelector("#editor"), {
      mode: 'clike',
      lineNumbers: true,
      keyMap: 'sublime',
      theme: 'material-darker',
      showCursorWhenSelecting: true
    });

    const defaultCode = {
      'cpp': '#include <iostream>\nusing namespace std;\n\nint main() {\n  cout << "Hello World";\n}',
      'python': '',
      'rust': 'fn main() {\n  println!("Hello World!");\n}'
    };

    const initLanguage = lang => {
      language = lang;
      window.localStorage.setItem('__cpppad-saved-language', lang);
      const savedStdin = window.localStorage.getItem('__cpppad-saved-stdin-' + lang);
      if (savedStdin) {
        document.querySelector("#stdin").value = savedStdin;
        document.querySelector("#stdindetails").setAttribute('open', true);
      }
      const savedCode = window.localStorage.getItem('__cpppad-saved-code-' + lang) || defaultCode[lang];
      cm.setValue(savedCode);
    };

    initLanguage(language);

    const $languageSelect = document.querySelector("#language-select");
    $languageSelect.value = language;
    $languageSelect.onchange = (e) => {
      initLanguage($languageSelect.value);
    };

    const executeCode = (editor) => {
      document.querySelector("#stdout").innerHTML = "Running...";
      document.querySelector("#stderr").innerHTML = "";
      const code = editor.getValue();
      const stdin = document.querySelector("#stdin").value;
      window.localStorage.setItem('__cpppad-saved-code-' + language, code);
      window.localStorage.setItem('__cpppad-saved-stdin-' + language, stdin);
      fetch('/execute', {
        method: 'POST',
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          stdin: stdin,
          code: code,
          lang: language
        })
      })
      .then(r => r.json())
      .then(output => {
        document.querySelector("#stdout").innerHTML = output.stdout;
        document.querySelector("#stderr").innerHTML = output.stderr;
      });
    };

    const customKey = {
      "Cmd-Enter": executeCode,
      "Ctrl-Enter": executeCode
    };

    cm.addKeyMap(customKey);
  </script>
</body>

</html>