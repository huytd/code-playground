<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <script src="lib/codemirror.min.js"></script>
  <link rel="stylesheet" href="lib/codemirror.css"/>
  <link rel="stylesheet" href="lib/material-darker.css">
  <script src="lib/clike.js"></script>
  <script src="lib/sublime.js"></script>
  <title>Code Playground</title>
  <style>
    html {
      box-sizing: border-box;
    }

    *, ::before, ::after {
      box-sizing: inherit;
    }

    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #282828;
      color: #ccc;
      display: flex;
      flex-direction: column;
      font-family: Monaco, 'Lucida Console', monospace;
      font-size: 12.5px;
    }

    .CodeMirror {
      width: 100%; height: 100%;
      font-family: Monaco, 'Lucida Console', monospace;
      font-size: 12.5px;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: row;
    }

    #editor {
      flex: 1;
    }

    #output {
      width: 35%;
      font-family: Monaco, 'Lucida Console', monospace;
      font-size: 12.5px;
      margin: 0; padding: 0;
      display: flex;
      flex-direction: column;
    }

    #output .output-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #222;
      margin: 0 0 3px 3px;
      padding: 5px;
    }

    #output .output-section.doubly {
      flex-direction: row;
    }

    #output .output-section.doubly .group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #output .output-section.doubly .group:last-child {
      border-left: 3px solid #282828;
      padding-left: 5px;
    }

    #output .output-section header {
      font-variant: small-caps;
      font-weight: bold;
      color: #666;
    }

    #output .output-section textarea {
      flex: 1;
      padding: 5px 0;
      outline: none;
      resize: none;
      background: none;
      border: none;
      color: #FFF;
    }

    #output .output-section pre {
      flex: 1;
      padding: 5px 0;
      overflow: auto;
    }

    #output .status-section {
      color: #666;
      background: #222;
      margin: 0 0 3px 3px;
      padding: 5px;
    }

    #output .status-section .icon {
      text-transform: lowercase;
      font-variant: normal;
      background-color: #666;
      color: #222;
      border-radius: 50%;
      font-size: 0.7em;
      text-align: center;
      width: 12.5px; height: 12.5px;
      display: inline-block;
      vertical-align: middle;
    }

    #output .status-section .icon.success {
      background-color: #C3E88D;
    }

    #output .status-section .icon.failed {
      background-color: #f07178;
    }

    #stderr {
      color: #f07178;
    }

    details summary {
      color: #888;
    }

    .header {
      padding: 10px 15px;
    }

    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: #333;
      border: 1px solid #555;
      color: #dddddd;
      padding: 3px 30px 3px 5px;
      position: relative;
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAAcUlEQVRIie2Puw2AMBQDHRZjnJSMAqlgWo6CIEFEIj5BNO9qy2dLhmH8B+CA9kKuBdyT8gDMQFfI+ZiZcpKm5JHkJPVnEsBLGmPmPvHFwMrhyW45pfWPJNXKE0nYSbby8Lo886TO8oKkfnki+abcMLIsXdC+QY2m3bcAAAAASUVORK5CYII=");
      background-repeat: no-repeat;
      background-position: center right;
    }

    #extra-flags {
      background: #333;
      border: 1px solid #555;
      color: #dddddd;
      padding: 3px 30px 3px 5px;
    }
  </style>
</head>

<body>
  <div class="header">
    language: <select id="language-select">
      <option value="cpp">C++</option>
      <option value="python">Python</option>
    </select>
    additional compile flags: <input type="text" id="extra-flags"/>
  </div>
  <div class="container">
    <div id="editor"></div>
    <div id="output">
      <div class="output-section doubly">
        <div class="group">
          <header>stdin</header>
          <textarea id="stdin"></textarea>
        </div>
        <div class="group">
          <header>expected stdout</header>
          <textarea id="expected-stdout"></textarea>
        </div>
      </div>
      <div class="output-section">
        <header>stdout</header>
        <pre id="stdout"></pre>
      </div>
      <div class="output-section">
        <header>stderr</header>
        <pre id="stderr"></pre>
      </div>
      <div id="status" class="status-section"><span class="icon">i</span> press ⌘ + enter or ^ + enter to execute</div>
    </div>
  </div>
  <script>
    let language = window.localStorage.getItem('__cpppad-saved-language') || 'cpp';

    const cm = CodeMirror(document.querySelector("#editor"), {
      mode: 'clike',
      lineNumbers: true,
      keyMap: 'sublime',
      theme: 'material-darker',
      showCursorWhenSelecting: true
    });

    const defaultCode = {
      'cpp': '#include <iostream>\nusing namespace std;\n\nint main() {\n  cout << "Hello World";\n}',
      'python': '',
    };

    const initLanguage = lang => {
      language = lang;
      window.localStorage.setItem('__cpppad-saved-language', lang);
      const savedStdin = window.localStorage.getItem('__cpppad-saved-stdin-' + lang);
      if (savedStdin) {
        document.querySelector("#stdin").value = savedStdin;
      }
      const savedCode = window.localStorage.getItem('__cpppad-saved-code-' + lang) || defaultCode[lang];
      cm.setValue(savedCode);
      const savedFlags = window.localStorage.getItem('__cpppad-saved-flags-' + lang) || '';
      document.querySelector('#extra-flags').value = savedFlags;
      const expectedOutput = window.localStorage.getItem('__cpppad-saved-expected-' + lang) || '';
      document.querySelector('#expected-stdout').value = expectedOutput;
    };

    initLanguage(language);

    const $languageSelect = document.querySelector("#language-select");
    $languageSelect.value = language;
    $languageSelect.onchange = (e) => {
      initLanguage($languageSelect.value);
    };

    const htmlEntities = (str) => {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    };

    const testOutput = () => {
      const expected = document.querySelector("#expected-stdout").value;
      if (expected.length) {
        const actual = document.querySelector("#stdout").innerHTML;
        if (expected === actual) {
          document.querySelector("#status").innerHTML = "<span style='color: #C3E88D;'><span class='icon success'>✔</span> test passed!</span>";
        } else {
          document.querySelector("#status").innerHTML = "<span style='color: #f07178;'><span class='icon failed'>!</span> test failed! stdout does not matched expected output.</span>";
        }
      } else {
        document.querySelector("#status").innerHTML = "<span class='icon'>i</span> press ⌘ + enter or ^ + enter to execute";
      }
    };

    const executeCode = (editor) => {
      document.querySelector("#status").innerHTML = "<span class='icon'>i</span> running...";
      document.querySelector("#stderr").innerHTML = "";
      const code = editor.getValue();
      const stdin = document.querySelector("#stdin").value;
      const flags = document.querySelector("#extra-flags").value;
      const expected = document.querySelector("#expected-stdout").value;
      window.localStorage.setItem('__cpppad-saved-code-' + language, code);
      window.localStorage.setItem('__cpppad-saved-stdin-' + language, stdin);
      window.localStorage.setItem('__cpppad-saved-flags-' + language, flags);
      window.localStorage.setItem('__cpppad-saved-expected-' + language, expected);
      fetch('/execute', {
        method: 'POST',
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          stdin: stdin,
          code: code,
          flags: flags,
          lang: language
        })
      })
      .then(r => r.json())
      .then(output => {
        document.querySelector("#stdout").innerHTML = htmlEntities(output.stdout);
        document.querySelector("#stderr").innerHTML = htmlEntities(output.stderr);
        testOutput();
      });
    };

    const customKey = {
      "Cmd-Enter": executeCode,
      "Ctrl-Enter": executeCode
    };

    cm.addKeyMap(customKey);
  </script>
</body>

</html>